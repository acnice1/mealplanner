<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meal Planner â€” Dinners & GF Dinners</title>
    <style>
      :root {
        --bg: #0b1320;
        --panel: #121a2b;
        --muted: #94a3b8;
        --text: #e6edf3;
        --accent: #60a5fa;
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
        --line: #1f2a44;
        --chip: #1b2741;
        --chip2: #0f172a;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      a {
        color: #9ec1ff;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        border-bottom: 1px solid var(--line);
        background: linear-gradient(180deg, var(--panel), #0e1628);
      }
      .tabs {
        display: flex;
        gap: 10px;
      }
      .tab {
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 10px;
        background: var(--chip);
        user-select: none;
      }
      .tab.active {
        background: var(--accent);
        color: #000;
      }
      .view {
        display: none;
        padding: 14px;
      }
      .view.active {
        display: block;
      }
      .btn {
        background: var(--accent);
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        color: #071426;
        box-shadow: var(--shadow);
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid var(--line);
        color: var(--text);
      }
      .btn.small {
        padding: 6px 9px;
        border-radius: 8px;
        font-size: 12px;
      }
      input,
      select,
      textarea {
        background: #0b162b;
        border: 1px solid var(--line);
        color: #e6edf3;
        border-radius: 10px;
        padding: 8px 10px;
      }
      .pill {
        background: var(--chip);
        border: 1px solid var(--line);
        padding: 4px 8px;
        border-radius: 999px;
        color: var(--muted);
        font-size: 12px;
      }

      /* Planner layout */
      .planner-wrap {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 12px;
      }
      .palette {
        background: #0d1830;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 10px;
        max-height: 75vh;
        overflow: auto;
      }
      .palette .search {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .recipe-card {
        background: #0e1b31;
        border: 1px solid #1c2d52;
        border-radius: 12px;
        margin-bottom: 8px;
        padding: 8px;
        cursor: grab;
      }
      .recipe-card:active {
        cursor: grabbing;
      }
      .recipe-card .name {
        font-weight: 700;
      }
      .recipe-card .tags {
        margin-top: 4px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .calendar {
        display: grid;
        gap: 8px;
      }
      .week {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }
      .day {
        background: #0d1830;
        border: 1px dashed #1e315a;
        border-radius: 16px;
        min-height: 140px;
        display: flex;
        flex-direction: column;
      }
      .day header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px dashed #1b2c52;
        background: #0c152b;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
      }
      .slots {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 10px;
      }
      .slot {
        background: var(--chip2);
        border: 1px solid var(--line);
        border-radius: 12px;
        min-height: 44px;
        padding: 6px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .slot[data-highlight="1"] {
        outline: 2px solid var(--accent);
      }
      .meal-pill {
        font-size: 11px;
        color: #cbd5e1;
        background: #0a1325;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 2px 6px;
      }
      .assignment {
        display: flex;
        gap: 6px;
        align-items: center;
        background: #0e1b31;
        border: 1px solid #1c2d52;
        border-radius: 10px;
        padding: 4px 6px;
      }
      .assignment .x {
        cursor: pointer;
        color: #93a7c6;
      }

      .sticky-bottom {
        position: sticky;
        bottom: 0;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      /* Recipes manager */
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .card {
        background: #0d1830;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 12px;
      }
      .list {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .list li {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-bottom: 1px solid #122044;
      }
      .ing-row {
        display: grid;
        grid-template-columns: 90px 110px 1fr 140px auto;
        gap: 6px;
        margin-bottom: 6px;
      }
      .ing-row input {
        width: 100%;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 50;
      }
      .modal.show {
        display: flex;
      }
      .sheet {
        background: #0c162b;
        border: 1px solid var(--line);
        border-radius: 18px;
        box-shadow: var(--shadow);
        max-width: 900px;
        width: 100%;
      }
      .sheet header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--line);
        padding: 10px 14px;
        background: #0a1325;
      }
      .sheet .body {
        padding: 12px;
        max-height: 70vh;
        overflow: auto;
      }

      /* Small inline calendar events list */
      .day .gcal {
        margin: 6px 10px 0;
        padding: 0;
        list-style: none;
      }
      .day .gcal li {
        font-size: 12px;
        color: #c7d2fe;
        margin-bottom: 2px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #0b1830;
        border: 1px solid var(--line);
        color: #9fb3d6;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="tabs">
        <div class="tab active" data-tab="planner">Planner</div>
        <div class="tab" data-tab="recipes">Recipes</div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center">
        <span
          id="calBadge"
          class="badge"
          title="Imported calendar events"
          style="display: none"
          >ðŸ“… <span id="calCount">0</span></span
        >
        <button class="btn ghost" id="btnExport">Export</button>
        <button class="btn ghost" id="btnImport">Import</button>
        <button class="btn ghost" id="btnICSImport">
          Import .ics (Calendar)
        </button>
        <button class="btn" id="btnGrocery">Grocery List</button>
        <button class="btn" id="btnICS">Download .ics</button>
      </div>
    </header>

    <!-- Planner view -->
    <div class="view active" id="planner">
      <div
        style="
          display: flex;
          gap: 8px;
          align-items: center;
          flex-wrap: wrap;
          margin-bottom: 10px;
        "
      >
        <button class="btn small ghost" id="prevWeek">â—€ Prev</button>
        <input type="date" id="weekStart" />
        <button class="btn small ghost" id="nextWeek">Next â–¶</button>
        <span class="pill" id="rangeLabel"></span>
        <span class="pill">Drag a recipe into Dinner / GF Dinner</span>
        <span class="pill">Double-click a slot to add free-text</span>
      </div>
      <div class="planner-wrap">
        <aside class="palette">
          <div class="search">
            <input id="search" placeholder="Search recipesâ€¦" style="flex: 1" />
            <select id="filterTag">
              <option value="">All</option>
            </select>
          </div>
          <div id="paletteList"></div>
        </aside>
        <section class="calendar">
          <div class="week" id="week"></div>
          <div class="sticky-bottom">
            <button class="btn small ghost" id="btnClearWeek">
              Clear week
            </button>
            <button class="btn small ghost" id="btnMonthView">
              Month view
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- Recipes view -->
    <div class="view" id="recipes">
      <div class="grid-2">
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h3 style="margin: 0">Your Recipes</h3>
            <button class="btn small" id="rm_new">+ New</button>
          </div>
          <ul class="list" id="rm_list"></ul>
        </div>
        <div class="card">
          <h3 style="margin: 0">Edit Recipe</h3>
          <div class="pill" id="rm_hint">
            Select a recipe or create a new one.
          </div>
          <div id="rm_editor" style="margin-top: 10px; display: none">
            <div class="grid-2">
              <label>Name<input id="rm_name" /></label>
              <label
                >Servings<input type="number" id="rm_servings" min="1"
              /></label>
              <label
                >Tags<input id="rm_tags" placeholder="comma separated"
              /></label>
              <label>Link<input id="rm_link" placeholder="https://â€¦" /></label>
            </div>
            <div
              class="divider"
              style="height: 1px; background: var(--line); margin: 10px 0"
            ></div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h4 style="margin: 0">Ingredients</h4>
              <button class="btn small" id="rm_add_ing">
                + Add ingredient
              </button>
            </div>
            <div id="rm_ing" style="margin-top: 6px"></div>
            <div
              class="divider"
              style="height: 1px; background: var(--line); margin: 10px 0"
            ></div>
            <label>Notes<textarea id="rm_notes" rows="3"></textarea></label>
            <div
              style="
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 10px;
              "
            >
              <button
                class="btn small ghost"
                id="rm_delete"
                style="
                  border-color: var(--bad);
                  background: var(--bad);
                  color: #fff;
                "
              >
                Delete
              </button>
              <button class="btn small" id="rm_save">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grocery Modal -->
    <div class="modal" id="groceryModal">
      <div class="sheet">
        <header>
          <div style="font-weight: 700">Grocery List</div>
          <button class="btn small ghost" data-close>Close</button>
        </header>
        <div class="body">
          <div class="grid-2">
            <div>
              <div class="h">By Category</div>
              <ul class="list" id="groceriesByCat"></ul>
            </div>
            <div>
              <div class="h">Flat List</div>
              <ul class="list" id="groceriesFlat"></ul>
              <div style="display: flex; gap: 8px; margin-top: 8px">
                <button class="btn small" id="btnCopyGrocery">Copy</button>
                <button class="btn small ghost" id="btnDownloadCSV">CSV</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Month Modal -->
    <div class="modal" id="monthModal">
      <div class="sheet">
        <header>
          <div style="font-weight: 700">Month View</div>
          <button class="btn small ghost" data-close>Close</button>
        </header>
        <div class="body" id="monthBody"></div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
      <div class="sheet">
        <header>
          <div style="font-weight: 700">Export Data</div>
          <button class="btn small ghost" data-close>Close</button>
        </header>
        <div class="body">
          <div class="h">Your data (recipes + plan + calendar)</div>
          <textarea id="exportText" rows="14" style="width: 100%"></textarea>
          <div style="display: flex; gap: 8px; margin-top: 8px">
            <button class="btn small" id="btnDownloadExport">
              Download JSON
            </button>
            <button class="btn small ghost" id="btnCopyExport">
              Copy JSON
            </button>
            <button
              class="btn small ghost"
              id="btnClearCalendar"
              title="Remove imported .ics events"
            >
              Clear Calendar
            </button>
          </div>
          <div class="note" style="margin-top: 8px">
            If downloading is blocked in this preview/sandbox, use Copy JSON.
          </div>
        </div>
      </div>
    </div>

    <script>
      /******************** Core State ********************/
      const MEALS = ["Dinner", "GF Dinner"];
      const STAPLES = new Set(["salt", "pepper", "oil", "olive oil", "water"]);
      const state = {
        recipes: [],
        plan: {},
        gcal: { events: [] }, // imported .ics events
        servingScale: 1,
        editingRid: null,
      };

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      /******************** Storage ********************/
      function save() {
        localStorage.setItem(
          "mealPlanner",
          JSON.stringify({
            recipes: state.recipes,
            plan: state.plan,
            gcal: state.gcal,
          })
        );
        updateCalBadge();
      }
      function load() {
        const s = localStorage.getItem("mealPlanner");
        if (s) {
          try {
            const o = JSON.parse(s);
            state.recipes = (o.recipes || []).map(enrichRecipe);
            state.plan = o.plan || {};
            state.gcal = o.gcal || { events: [] };
          } catch (e) {
            console.warn("bad save", e);
          }
        }
        if (state.recipes.length === 0) seed();
      }

      function seed() {
        const demo = [
          {
            name: "Spaghetti Bolognese",
            servings: 4,
            tags: ["quick"],
            link: "",
            ingredients: [
              { qty: 500, unit: "g", item: "spaghetti", cat: "grains" },
              { qty: 1, unit: "lb", item: "ground beef", cat: "meat" },
              { qty: 1, unit: "jar", item: "tomato sauce", cat: "canned" },
              { qty: 1, unit: "", item: "onion", cat: "produce" },
            ],
            notes: "",
          },
          {
            name: "Chicken Stir Fry",
            servings: 4,
            tags: ["quick", "kid-friendly"],
            link: "",
            ingredients: [
              { qty: 2, unit: "breast", item: "chicken", cat: "meat" },
              { qty: 2, unit: "cup", item: "mixed vegetables", cat: "produce" },
              { qty: 1, unit: "cup", item: "rice", cat: "grains" },
              { qty: 2, unit: "tbsp", item: "soy sauce", cat: "condiments" },
            ],
            notes: "",
          },
          {
            name: "Veggie Chili",
            servings: 6,
            tags: ["vegan"],
            link: "",
            ingredients: [
              { qty: 2, unit: "can", item: "beans", cat: "canned" },
              { qty: 1, unit: "can", item: "diced tomatoes", cat: "canned" },
              { qty: 1, unit: "", item: "onion", cat: "produce" },
              { qty: 2, unit: "clove", item: "garlic", cat: "produce" },
            ],
            notes: "",
          },
        ];
        state.recipes = demo.map(enrichRecipe);
        save();
      }

      function enrichRecipe(r) {
        return {
          id: r.id || crypto.randomUUID(),
          name: (r.name || "").trim(),
          servings: Number(r.servings) || 4,
          tags: r.tags || [],
          link: r.link || "",
          ingredients: (r.ingredients || []).map(cleanIng),
          notes: r.notes || "",
        };
      }
      function cleanIng(x) {
        return {
          qty: Number(x.qty) || 0,
          unit: (x.unit || "").trim(),
          item: (x.item || "").trim(),
          cat: (x.cat || "").trim().toLowerCase(),
        };
      }

      /******************** Date helpers ********************/
      const fmtDate = (d) => d.toISOString().slice(0, 10);
      function startOfWeek(d) {
        const x = new Date(d);
        const day = x.getDay();
        const diff = (day + 6) % 7;
        x.setDate(x.getDate() - diff);
        x.setHours(0, 0, 0, 0);
        return x;
      }
      function endOfWeek(d) {
        const x = startOfWeek(d);
        x.setDate(x.getDate() + 6);
        return x;
      }
      function dateRangeArray(start, end) {
        const arr = [];
        const d = new Date(start);
        const e = new Date(end);
        d.setHours(0, 0, 0, 0);
        e.setHours(0, 0, 0, 0);
        while (d <= e) {
          arr.push(fmtDate(d));
          d.setDate(d.getDate() + 1);
        }
        return arr;
      }

      /******************** Plan helpers ********************/
      function ensureDay(dateStr) {
        let day = state.plan[dateStr];
        if (!day) day = {};
        MEALS.forEach((m) => {
          if (!Array.isArray(day[m])) day[m] = [];
        });
        state.plan[dateStr] = day;
        return day;
      }
      function resetDay(dateStr) {
        const day = {};
        MEALS.forEach((m) => (day[m] = []));
        state.plan[dateStr] = day;
        return day;
      }

      /******************** .ICS import & parsing ********************/
      // Minimal iCalendar parser extracting SUMMARY / DTSTART / DTEND
      // Stores events as { summary, allDay, start: "YYYY-MM-DD", end: "YYYY-MM-DD" | null, startDT?: ISO, endDT?: ISO }
      function unfoldICS(text) {
        // Join folded lines (those starting with space or tab)
        const lines = text.replace(/\r\n/g, "\n").split("\n");
        const out = [];
        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];
          while (i + 1 < lines.length && /^[ \t]/.test(lines[i + 1])) {
            line += lines[i + 1].slice(1);
            i++;
          }
          out.push(line);
        }
        return out;
      }
      function parseICalDate(val) {
        // YYYYMMDD or YYYYMMDDT...Z / with timezone (weâ€™ll best-effort)
        if (!val) return null;
        if (/^\d{8}$/.test(val)) {
          const y = val.slice(0, 4),
            m = val.slice(4, 6),
            d = val.slice(6, 8);
          return { allDay: true, date: `${y}-${m}-${d}` };
        }
        // Date-Time: YYYYMMDDTHHMMSSZ or without Z. We convert to local ISO string.
        const m = val.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?/);
        if (m) {
          const [_, Y, Mo, Da, H, Mi, S, z] = m;
          if (z) {
            const d = new Date(Date.UTC(+Y, +Mo - 1, +Da, +H, +Mi, +S));
            return { allDay: false, dateTime: d.toISOString() };
          } else {
            // Treat as local
            const d = new Date(+Y, +Mo - 1, +Da, +H, +Mi, +S);
            return {
              allDay: false,
              dateTime: new Date(
                d.getTime() - d.getTimezoneOffset() * 60000
              ).toISOString(),
            };
          }
        }
        return null;
      }
      function parseICS(text) {
        const lines = unfoldICS(text);
        const events = [];
        let inEvent = false;
        let cur = {};
        for (const raw of lines) {
          const line = raw.trim();
          if (line === "BEGIN:VEVENT") {
            inEvent = true;
            cur = {};
            continue;
          }
          if (line === "END:VEVENT") {
            // finalize
            const ev = { summary: cur.SUMMARY || "(no title)" };
            const dtStart = parseICalDate(cur.DTSTART?.value || cur.DTSTART);
            const dtEnd = parseICalDate(cur.DTEND?.value || cur.DTEND);
            if (dtStart?.allDay) {
              ev.allDay = true;
              ev.start = dtStart.date;
              ev.end = dtEnd?.date || null;
            } else {
              ev.allDay = false;
              ev.startDT = dtStart?.dateTime || null;
              ev.endDT = dtEnd?.dateTime || null;
              // also set friendly start (YYYY-MM-DD) for grouping
              if (ev.startDT) ev.start = ev.startDT.slice(0, 10);
            }
            events.push(ev);
            inEvent = false;
            cur = {};
            continue;
          }
          if (!inEvent) continue;

          // Split property; handle params like DTSTART;TZID=America/Toronto:
          const idx = line.indexOf(":");
          if (idx === -1) continue;
          const keyPart = line.slice(0, idx);
          const value = line.slice(idx + 1);
          const semi = keyPart.indexOf(";");
          if (semi !== -1) {
            const prop = keyPart.slice(0, semi).toUpperCase();
            const params = keyPart.slice(semi + 1);
            cur[prop] = { params, value };
          } else {
            const prop = keyPart.toUpperCase();
            cur[prop] = value;
          }
        }
        return events;
      }

      function getEventsForDate(dateStr) {
        // All-day matches if start <= date <= (end-1 day) or equals start if no end.
        // Timed events match by start date.
        const list = [];
        for (const e of state.gcal.events) {
          if (e.allDay) {
            if (e.start === dateStr)
              list.push({ time: "All-day", title: e.summary });
            else if (e.end) {
              const sd = new Date(e.start),
                ed = new Date(e.end);
              const cur = new Date(dateStr);
              sd.setHours(0, 0, 0, 0);
              ed.setHours(0, 0, 0, 0);
              cur.setHours(0, 0, 0, 0);
              // iCal DTEND is exclusive for all-day multi-day events
              if (cur >= sd && cur < ed)
                list.push({ time: "All-day", title: e.summary });
            }
          } else if (e.startDT) {
            if (e.start === dateStr) {
              const t = new Date(e.startDT).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
              list.push({ time: t, title: e.summary });
            }
          }
        }
        return list.sort((a, b) => a.time.localeCompare(b.time));
      }

      function updateCalBadge() {
        const n = state.gcal?.events?.length || 0;
        const badge = $("#calBadge");
        $("#calCount").textContent = String(n);
        badge.style.display = n ? "inline-flex" : "none";
      }

      async function importICSFile() {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = ".ics,text/calendar";
        inp.onchange = async () => {
          const f = inp.files?.[0];
          if (!f) return;
          const text = await f.text();
          try {
            const events = parseICS(text);
            state.gcal = { events };
            save();
            renderWeek(); // annotate week with events
            alert(`Imported ${events.length} calendar events.`);
          } catch (e) {
            console.error(e);
            alert("Failed to parse .ics file.");
          }
        };
        inp.click();
      }

      /******************** Palette & Planner rendering ********************/
      function renderPalette() {
        const q = $("#search").value.toLowerCase();
        const tag = $("#filterTag").value;
        const wrap = $("#paletteList");
        wrap.innerHTML = "";
        // tag options
        const tagSet = new Set();
        state.recipes.forEach((r) => r.tags.forEach((t) => tagSet.add(t)));
        const sel = $("#filterTag");
        const prev = sel.value;
        sel.innerHTML =
          '<option value="">All</option>' +
          Array.from(tagSet)
            .sort()
            .map((t) => `<option ${t === prev ? "selected" : ""}>${t}</option>`)
            .join("");
        // list
        const list = state.recipes
          .filter(
            (r) =>
              (r.name.toLowerCase().includes(q) ||
                r.tags.some((t) => t.toLowerCase().includes(q))) &&
              (!tag || r.tags.includes(tag))
          )
          .sort((a, b) => a.name.localeCompare(b.name));
        list.forEach((r) => {
          const card = document.createElement("div");
          card.className = "recipe-card";
          card.draggable = true;
          card.dataset.rid = r.id;
          card.innerHTML = `<div class="name">${
            r.name
          }</div><div class="tags">${r.tags
            .map((t) => `<span class="pill">${t}</span>`)
            .join("")}</div>${
            r.link
              ? `<div class="pill" style="margin-top:6px"><a href="${r.link}" target="_blank">link</a></div>`
              : ""
          }`;
          card.addEventListener("dragstart", onDragStart);
          wrap.appendChild(card);
        });
      }

      function renderWeek() {
        const start = startOfWeek(new Date($("#weekStart").value));
        const end = endOfWeek(start);
        $(
          "#rangeLabel"
        ).textContent = `${start.toLocaleDateString()} â€“ ${end.toLocaleDateString()}`;
        const grid = $("#week");
        grid.innerHTML = "";
        for (let i = 0; i < 7; i++) {
          const d = new Date(start);
          d.setDate(start.getDate() + i);
          const ds = fmtDate(d);
          const day = ensureDay(ds);
          const el = document.createElement("div");
          el.className = "day";
          el.dataset.date = ds;
          el.innerHTML = `<header><div>${d.toLocaleDateString(undefined, {
            weekday: "short",
            month: "short",
            day: "numeric",
          })}</div><button class="btn small ghost" data-clear>Clear</button></header>
          <div class="slots">${MEALS.map(
            (m) =>
              `<div class="slot" data-meal="${m}"><span class="meal-pill">${m}</span><div class="assignments"></div></div>`
          ).join("")}</div>`;

          // Clear button
          el.querySelector("[data-clear]").addEventListener("click", () => {
            resetDay(ds);
            save();
            renderWeek();
          });

          // Drag slots
          el.querySelectorAll(".slot").forEach((slot) => {
            slot.addEventListener("dragover", onDragOver);
            slot.addEventListener(
              "dragleave",
              (e) => (e.currentTarget.dataset.highlight = "")
            );
            slot.addEventListener("drop", onDrop);
            slot.addEventListener("dblclick", () =>
              addFreeText(ds, slot.dataset.meal)
            );
          });

          // Fill assignments
          el.querySelectorAll(".slot").forEach((slot) => {
            const meal = slot.dataset.meal;
            const list = day[meal] || [];
            const wrap = slot.querySelector(".assignments");
            wrap.innerHTML = "";
            list.forEach((a, idx) => {
              const chip = document.createElement("div");
              chip.className = "assignment";
              chip.innerHTML = `<span>${a.name}</span> <span class="x" title="Remove">âœ•</span>`;
              chip.querySelector(".x").addEventListener("click", () => {
                list.splice(idx, 1);
                save();
                renderWeek();
              });
              wrap.appendChild(chip);
            });
          });

          // Inject up to 3 Google Calendar events for that day
          const evs = getEventsForDate(ds).slice(0, 3);
          if (evs.length) {
            const ul = document.createElement("ul");
            ul.className = "gcal";
            evs.forEach((e) => {
              const li = document.createElement("li");
              li.textContent = `${e.time} â€” ${e.title}`;
              ul.appendChild(li);
            });
            el.querySelector(".slots").prepend(ul);
          }

          grid.appendChild(el);
        }
      }

      function addFreeText(dateStr, meal) {
        const txt = prompt('Quick add (e.g. "Leftovers" or "Restaurant")');
        if (!txt) return;
        ensureDay(dateStr)[meal].push({ rid: null, name: txt, scale: 1 });
        save();
        renderWeek();
      }

      /******************** Drag & Drop ********************/
      function onDragStart(e) {
        e.dataTransfer.setData("text/plain", e.currentTarget.dataset.rid);
      }
      function onDragOver(e) {
        e.preventDefault();
        e.currentTarget.dataset.highlight = "1";
      }
      function onDrop(e) {
        e.preventDefault();
        const rid = e.dataTransfer.getData("text/plain");
        e.currentTarget.dataset.highlight = "";
        const dateStr = e.currentTarget.closest(".day").dataset.date;
        const meal = e.currentTarget.dataset.meal;
        const r = state.recipes.find((x) => x.id === rid);
        if (!r) return;
        ensureDay(dateStr)[meal].push({ rid: r.id, name: r.name, scale: 1 });
        save();
        renderWeek();
      }

      /******************** Recipes Tab ********************/
      function renderRecipeList() {
        const ul = $("#rm_list");
        ul.innerHTML = "";
        state.recipes
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((r) => {
            const li = document.createElement("li");
            li.innerHTML = `<strong style="flex:1">${r.name}</strong> <span class="pill">serves ${r.servings}</span> <button class="btn small ghost" data-edit="${r.id}">Edit</button>`;
            ul.appendChild(li);
          });
        ul.querySelectorAll("[data-edit]").forEach((btn) =>
          btn.addEventListener("click", () =>
            openRecipeEditor(btn.dataset.edit)
          )
        );
      }

      function openRecipeEditor(rid) {
        const r =
          state.recipes.find((x) => x.id === rid) ||
          enrichRecipe({
            name: "",
            servings: 4,
            tags: [],
            link: "",
            ingredients: [],
            notes: "",
          });
        state.editingRid = r.id || null;
        $("#rm_hint").style.display = "none";
        $("#rm_editor").style.display = "block";
        $("#rm_name").value = r.name;
        $("#rm_servings").value = r.servings;
        $("#rm_tags").value = (r.tags || []).join(", ");
        $("#rm_link").value = r.link;
        $("#rm_notes").value = r.notes;
        renderIngredientRows(r.ingredients || []);
      }

      function ingredientRow(i) {
        const row = document.createElement("div");
        row.className = "ing-row";
        row.innerHTML = `<input type="number" step="any" placeholder="Qty" value="${
          i.qty || ""
        }">
          <input placeholder="Unit" value="${i.unit || ""}">
          <input placeholder="Ingredient" value="${i.item || ""}">
          <input placeholder="Category (e.g., produce)" value="${i.cat || ""}">
          <button class="btn small ghost">âœ•</button>`;
        row
          .querySelector("button")
          .addEventListener("click", () => row.remove());
        return row;
      }
      function renderIngredientRows(arr) {
        const host = $("#rm_ing");
        host.innerHTML = "";
        if (arr.length === 0) arr = [{ qty: 0, unit: "", item: "", cat: "" }];
        arr.forEach((i) => host.appendChild(ingredientRow(i)));
      }
      function addIngredientRow() {
        $("#rm_ing").appendChild(
          ingredientRow({ qty: 0, unit: "", item: "", cat: "" })
        );
      }

      function saveFromEditor() {
        const rec = {
          id: state.editingRid || crypto.randomUUID(),
          name: $("#rm_name").value.trim(),
          servings: Number($("#rm_servings").value) || 4,
          tags: $("#rm_tags")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean),
          link: $("#rm_link").value.trim(),
          ingredients: Array.from($("#rm_ing").children)
            .map((row) => {
              const [q, u, it, cat] = Array.from(
                row.querySelectorAll("input")
              ).map((x) => x.value);
              return cleanIng({ qty: q, unit: u, item: it, cat: cat });
            })
            .filter((x) => x.item),
          notes: $("#rm_notes").value.trim(),
        };
        const idx = state.recipes.findIndex((x) => x.id === rec.id);
        if (idx > -1) state.recipes[idx] = rec;
        else state.recipes.push(rec);
        save();
        renderPalette();
        renderRecipeList();
        alert("Saved");
      }

      function deleteCurrentRecipe() {
        if (!state.editingRid) return;
        if (!confirm("Delete this recipe?")) return;
        const i = state.recipes.findIndex((x) => x.id === state.editingRid);
        if (i > -1) state.recipes.splice(i, 1);
        state.editingRid = null;
        save();
        renderPalette();
        renderRecipeList();
        $("#rm_editor").style.display = "none";
        $("#rm_hint").style.display = "inline-block";
      }

      /******************** Grocery List ********************/
      function aggregateGrocery(rangeDates) {
        const map = new Map();
        for (const ds of rangeDates) {
          const day = state.plan[ds];
          if (!day) continue;
          for (const meal of MEALS) {
            for (const a of day[meal] || []) {
              const r = state.recipes.find((x) => x.id === a.rid);
              if (!r) continue;
              const mult = a.scale || 1;
              for (const ing of r.ingredients) {
                const key = (ing.item + "|" + ing.unit).toLowerCase();
                if (!map.has(key))
                  map.set(key, {
                    qty: 0,
                    unit: ing.unit,
                    item: ing.item,
                    cat: ing.cat || "",
                  });
                map.get(key).qty +=
                  ((Number(ing.qty) || 0) * mult) / (r.servings || 1);
              }
            }
          }
        }
        return Array.from(map.values()).filter(
          (x) => !STAPLES.has(x.item.toLowerCase())
        );
      }

      function openGroceries() {
        const start = startOfWeek(new Date($("#weekStart").value));
        const end = endOfWeek(start);
        const dates = dateRangeArray(start, end);
        const items = aggregateGrocery(dates);
        const byCat = new Map();
        items.forEach((x) => {
          const c = x.cat || "other";
          if (!byCat.has(c)) byCat.set(c, []);
          byCat.get(c).push(x);
        });
        const fmt = (v) => (Math.round(v * 100) / 100).toString();
        $("#groceriesByCat").innerHTML = Array.from(byCat.entries())
          .sort()
          .map(
            ([c, arr]) =>
              `<li><strong style="text-transform:capitalize">${c}</strong></li>` +
              arr
                .map(
                  (i) =>
                    `<li><input type="checkbox"> ${fmt(i.qty)} ${i.unit} ${
                      i.item
                    }</li>`
                )
                .join("")
          )
          .join("");
        $("#groceriesFlat").innerHTML = items
          .map(
            (i) =>
              `<li><input type="checkbox"> ${fmt(i.qty)} ${i.unit} ${
                i.item
              } <span class="pill">(${i.cat || "other"})</span></li>`
          )
          .join("");
        show("#groceryModal", true);
      }

      function groceriesText() {
        return $$("#groceriesFlat li")
          .map((li) => li.textContent.trim())
          .join("\n");
      }
      function downloadCSV() {
        const rows = [["qty", "unit", "item", "category"]];
        $$("#groceriesFlat li").forEach((li) => {
          const txt = li.textContent.trim();
          const m = txt.match(/^(\d+(?:\.\d+)?)\s+(\S*)\s+(.*?)\s+\((.*?)\)$/);
          if (m) rows.push([m[1], m[2], m[3], m[4]]);
        });
        const csv = rows
          .map((r) =>
            r.map((x) => '"' + (x || "").replaceAll('"', '""') + '"').join(",")
          )
          .join("\n");
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
        a.download = "groceries.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      /******************** Calendar (.ics) ********************/
      function composeDaySummary(day) {
        const names = [];
        MEALS.forEach((m) =>
          (day?.[m] || []).forEach((a) => names.push(a.name))
        );
        return names.join(", ");
      }
      function buildICSForWeek() {
        const start = startOfWeek(new Date($("#weekStart").value));
        const end = endOfWeek(start);
        const dates = dateRangeArray(start, end);
        const lines = [
          "BEGIN:VCALENDAR",
          "VERSION:2.0",
          "PRODID:-//MealPlanner//EN",
        ];
        dates.forEach((ds) => {
          const day = state.plan[ds];
          const summary = composeDaySummary(day);
          if (!summary) return;
          const dt = ds.replace(/-/g, "");
          lines.push("BEGIN:VEVENT");
          lines.push(`UID:${crypto.randomUUID()}@mealplanner`);
          lines.push(`DTSTAMP:${dt}T090000Z`);
          lines.push(`DTSTART;VALUE=DATE:${dt}`);
          lines.push(
            `SUMMARY:${summary.replace(
              /[\\n,;]/g,
              (m) => ({ "\\n": "\\n", ",": "\\,", ";": "\\;" }[m])
            )}`
          );
          lines.push("END:VEVENT");
        });
        lines.push("END:VCALENDAR");
        return lines.join("\n");
      }
      function downloadICS() {
        const ics = buildICSForWeek();
        const blob = new Blob([ics], { type: "text/calendar" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "mealplan.ics";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      /******************** Import / Export ********************/
      function buildExportJSON() {
        return JSON.stringify(
          { recipes: state.recipes, plan: state.plan, gcal: state.gcal },
          null,
          2
        );
      }
      function exportAll() {
        const data = buildExportJSON();
        try {
          const blob = new Blob([data], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "mealplanner.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          const w = window.open();
          if (w) {
            w.document.write(
              "<pre>" +
                data.replace(
                  /[&<>]/g,
                  (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])
                ) +
                "</pre>"
            );
            w.document.close();
          } else alert("Allow popups to export.");
        }
      }
      function importAll() {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = "application/json";
        inp.onchange = () => {
          const f = inp.files[0];
          if (!f) return;
          const r = new FileReader();
          r.onload = () => {
            try {
              const obj = JSON.parse(r.result);
              if (obj.recipes && obj.plan) {
                state.recipes = obj.recipes.map(enrichRecipe);
                state.plan = obj.plan;
                state.gcal = obj.gcal || { events: [] };
                save();
                renderPalette();
                renderWeek();
                renderRecipeList();
              } else alert("Invalid file");
            } catch (e) {
              alert("Parse error");
            }
          };
          r.readAsText(f);
        };
        inp.click();
      }
      function openExportModal() {
        $("#exportText").value = buildExportJSON();
        show("#exportModal", true);
      }
      function clearCalendar() {
        if (!state.gcal?.events?.length) {
          alert("No imported calendar events to clear.");
          return;
        }
        if (!confirm("Remove all imported .ics events?")) return;
        state.gcal = { events: [] };
        save();
        renderWeek();
      }

      /******************** Month View ********************/
      function openMonth() {
        const start = new Date($("#weekStart").value);
        start.setDate(1);
        const y = start.getFullYear(),
          m = start.getMonth();
        const first = new Date(y, m, 1),
          last = new Date(y, m + 1, 0);
        const days = [];
        for (let d = 1; d <= last.getDate(); d++) days.push(new Date(y, m, d));
        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(7,1fr)";
        grid.style.gap = "6px";
        ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach((w) => {
          const h = document.createElement("div");
          h.textContent = w;
          h.style.color = "#94a3b8";
          grid.appendChild(h);
        });
        const offset = (first.getDay() + 6) % 7;
        for (let i = 0; i < offset; i++)
          grid.appendChild(document.createElement("div"));
        days.forEach((d) => {
          const ds = fmtDate(d);
          const box = document.createElement("div");
          box.className = "card";
          box.style.minHeight = "90px";
          const meals = state.plan[ds];
          const events = getEventsForDate(ds)
            .slice(0, 2)
            .map((e) => `${e.time} ${e.title}`)
            .join(" Â· ");
          box.innerHTML = `<div style="font-weight:700">${d.getDate()}</div>
            <div class="pill">${composeDaySummary(meals)}</div>
            ${
              events
                ? `<div class="pill" style="margin-top:6px">${events}</div>`
                : ""
            }`;
          grid.appendChild(box);
        });
        const body = $("#monthBody");
        body.innerHTML = "";
        body.appendChild(grid);
        show("#monthModal", true);
      }

      /******************** Modal helpers & Tabs ********************/
      function show(sel, on) {
        const m = $(sel);
        if (on) m.classList.add("show");
        else m.classList.remove("show");
      }
      $$(".modal [data-close]").forEach((btn) =>
        btn.addEventListener("click", (e) =>
          show("#" + e.currentTarget.closest(".modal").id, false)
        )
      );

      // Tabs
      $$(".tab").forEach((tab) =>
        tab.addEventListener("click", () => {
          $$(".tab").forEach((t) => t.classList.remove("active"));
          $$(".view").forEach((v) => v.classList.remove("active"));
          tab.classList.add("active");
          $("#" + tab.dataset.tab).classList.add("active");
          if (tab.dataset.tab === "recipes") renderRecipeList();
        })
      );

      /******************** Events ********************/
      // Planner controls
      $("#prevWeek").addEventListener("click", () => {
        const d = new Date($("#weekStart").value);
        d.setDate(d.getDate() - 7);
        $("#weekStart").value = fmtDate(d);
        renderWeek();
      });
      $("#nextWeek").addEventListener("click", () => {
        const d = new Date($("#weekStart").value);
        d.setDate(d.getDate() + 7);
        $("#weekStart").value = fmtDate(d);
        renderWeek();
      });
      $("#weekStart").addEventListener("change", renderWeek);
      $("#btnClearWeek").addEventListener("click", () => {
        if (confirm("Clear all meals for this week?")) {
          const s = startOfWeek(new Date($("#weekStart").value));
          const e = endOfWeek(s);
          dateRangeArray(s, e).forEach((ds) => resetDay(ds));
          save();
          renderWeek();
        }
      });
      $("#btnMonthView").addEventListener("click", openMonth);

      // Palette
      $("#search").addEventListener("input", renderPalette);
      $("#filterTag").addEventListener("change", renderPalette);

      // Groceries & export
      $("#btnGrocery").addEventListener("click", openGroceries);
      $("#btnCopyGrocery").addEventListener("click", () => {
        navigator.clipboard.writeText(groceriesText());
        alert("Copied!");
      });
      $("#btnDownloadCSV").addEventListener("click", downloadCSV);
      $("#btnICS").addEventListener("click", downloadICS);
      $("#btnExport").addEventListener("click", openExportModal);
      $("#btnImport").addEventListener("click", importAll);
      $("#btnDownloadExport").addEventListener("click", exportAll);
      $("#btnCopyExport").addEventListener("click", () => {
        navigator.clipboard.writeText($("#exportText").value);
        alert("Copied!");
      });
      $("#btnClearCalendar").addEventListener("click", clearCalendar);

      // .ics import
      $("#btnICSImport").addEventListener("click", importICSFile);

      // Recipes tab
      $("#rm_new").addEventListener("click", () => openRecipeEditor(null));
      $("#rm_add_ing").addEventListener("click", addIngredientRow);
      $("#rm_save").addEventListener("click", saveFromEditor);
      $("#rm_delete").addEventListener("click", deleteCurrentRecipe);

      /******************** Init ********************/
      load();
      const today = startOfWeek(new Date());
      $("#weekStart").value = fmtDate(today);
      updateCalBadge();
      renderPalette();
      renderWeek();
    </script>
  </body>
</html>
